# 报文格式：
| 1   | 用户信息上报   | 用户端（aciton=1）   | 
|:----|:----|:----|
| 2   | 付款上报   | 用户端（aciton=2）   | 
| 3   | 下车上报   | 用户端（aciton=3）   | 
| 4   | 车辆信息上报   | 司机端（aciton=4）   | 
| 5   | 车辆信息广播   | 用户端（aciton=5）   | 

# Redis缓存
| 序号   | 键   | 说明   | 
|:----|:----|:----|
| 1   | {学校标识}_riding_user{用户标识}   | 用户信息   | 
| 2   | payment_user_{用户标识}   | 支付用户   | 
| 3   | {设备标识}_times_payment_user{用户标识}   | 付款记录   | 
| 4   | {设备标识}_total_payment_users   | 总付款人数   | 
| 5   | {设备标识}_get_off_num   | 下车申请人数   | 
| 6   | {设备标识}_get_off_promp   | 下车提醒   | 
| 7   | riding_car{设备标识}   | 车辆信息   | 
| 8   | {设备标识}_payment_records   | 付款记录   | 

# 用户登录
```
/api/user/login
参数
project  //项目 jinhui-coupon jinhui-bus jinhui-qrcode
from     //来源 wx xcx unionpay web app
//自动登录
code     //微信或小程序code
nickname //可选昵称
head     //可选头像
//手动登录
mobile   //手机号登录
pwd      //账户密码（配合手机号登录）
//验证码登录
verify   //验证码
返回
code              //200成功
data token        //登录凭证，需要在接口header公共参数增加传递
data token_expire //凭证有效期
data group_ids    //用户分组ID组，英文逗号间隔
data group_names  //用户分组名称组，英文逗号间隔
```
# 乘车
## 学校列表
接口地址：bus/school/list

请求方式：POST

请求参数：无

响应数据：

```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "6", // id
            "name": "测试学校", // 名称
            "position": "POLYGON((121.474243 31.234504,121.471775 31.233348,121.470724 31.23155,121.471603 31.230229,121.472655 31.230357,121.475777 31.232045,121.474243 31.234504))", // 学校区域坐标
            "bus_line": "MULTILINESTRING((121.474243 31.234504,121.471775 31.233348,121.470724 31.23155))" // 校车线路图
        }
    ]
}
```
## 获取学校
接口地址：bus/school/get

请求方式：POST

请求参数：

```
device_no // 设备编号
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "1",// 序列id
            "sn": "862060040532476",// 编号设备
            "school_id": "8",// 学校id
            "school_position": "POLYGON((121.474243 31.234504,121.471775 31.233348,121.470724 31.23155,121.471603 31.230229,121.472655 31.230357,121.475777 31.232045,121.474243 31.234504))",// 校区区域坐标
            "school_bus_line": "MULTILINESTRING((121.474243 31.234504,121.471775 31.233348,121.470724 31.23155))"// 校区线路图
        }
    ]
}
```
## 公告列表
接口地址：bus/article/list

请求方式：POST

请求参数：

```
school_id  // 学校id
more // 更多标识：0=显示最新的5条，非0显示所有，more为0时page、size无效
page // 当前页数
size // 每页查询条数
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "3",// 公告id
            "title": "广告测试2",// 标题
            "release_time": "1970-01-01 08:00:00" // 发布时间
        }
    ]
}
```
## 公告详情
接口地址：bus/article/detail

请求方式：POST

请求参数：

```
id // 公告id
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "1",// id
            "title": "券定义",// 标题
            "content": "仅商家自己发布、使用范围仅限自己；发布生效不得删改，仅能下架未售出；售价限制1~9.99，券额一倍以上；订单金额需大于券额，不得叠加使用；券销售商家平台55分，消费完成结算。",//内容
            "release_time": "1970-01-01 08:00:00",// 发布时间
            "nickname": null,// 发布人昵称
            "realname": null // 发布人真实姓名
        }
    ]
}
```
## 使用协议
接口地址：bus/article/usetreaty

请求方式：POST

请求参数：无

响应数据：

```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "content": "测试如果说有车使用协议"
        }
    ]
}
```
## 获取用户手机号？
接口地址：bus/user/getmobile

请求方式：POST

请求参数：

```
user_id // 用户id
encryptedData // 包括敏感数据在内的完整用户信息的加密数据
iv //加密算法的初始向量
code // 登录凭证
```
响应数据：
```
与如果说有券相同
```
## 校车列表
接口地址：bus/bus/list

请求方式：POST

请求参数：

```
school_id // 学校id
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "1",// id
            "no": "001", // 编号
            "device_id": "1", // 设备id
            "device_no": "862060040532476" // 设备编号
        }
    ]
}
```
## 支付
接口地址：bus/orders/sdpay

请求方式：POST

请求参数：

```
user_id // 用户id
total_amount // 支付总金额（分）
openid // 用户标识
bus_id // 校车ID
ticket // 票张数
school_id // 学校ID
```
响应数据：
```
```
# 我的
## 使用记录
接口地址：bus/orders/list

请求方式：POST

请求参数：

```
user_id // 用户id
date // 支付日期：格式yyyy-mm-dd 搜索时传入
page // 当前页数
size // 每页查询条数
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "81",// 记录id
            "no": "201908070956141278",// 订单号
            "total_amount": "1",// 支付金额（分）
            "discount_amount": "0",// 优惠金额
            "pay_type": "1",// 0无 1微信
            "paid_time": "2019-08-08 01:56:29", // 支付时间
            "bus_no": "001",// 校车编号
            "evaluated": "1"// 评价：0未评价1已评价
        }
    ]
```
## }

用户最后一条付款记录
接口地址：bus/orders/lastorder

请求方式：POST

请求参数：

```
user_id // 用户id
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "115",// 订单id
            "ticket": "1",// 购票数量
            "device_id": "1",// 设备id
            "device_sn": "001" // 设备编号
        }
    ]
```
## }

评价语模板
接口地址：bus/orders/evaluatetmp

请求方式：POST

请求参数：无

响应数据：

```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "name": "五星",// 星级名称
            "value": "非常好|特别好"// 评价语
        }
    ]
```
## }

评价订单
接口地址：bus/orders/evaluate

请求方式：POST

请求参数：

```
order_id // 订单id
user_id// 用户id
star // 评价星数：1,2,3,4,5
detail// 内容
imgs// 图片，多张图片用英文逗号“,”隔开
propose // 服务建议
```
响应数据：
```
{
    "code": 200,
    "msg": "success"
}
```
## 查看评价
接口地址：bus/orders/evaluateinfo

请求方式：POST

请求参数：

```
order_id// 订单id
```
响应数据
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "star": "5",// 星级
            "detail": "非常好",// 内容
            "imgs": "/img/1.png",// 图片
            "evaluate_time": "2019-08-07 18:18:04"// 评价时间
        }
    ]
```
## }

使用须知
接口地址：bus/article/useinstruction

请求方式：POST

请求参数：无

响应数据：

```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "content": "测试而已"// 内容
        }
    ]
```
## }

客服热线
接口地址：bus/dictionary/servicehotline

请求方式：POST

请求参数：无

响应数据：

```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "name": "客服热线",// 名称
            "value": "023-88888888 // 热线号码
        }
    ]
}
```
## 暂停使用
接口地址：bus/user/suspend

请求方式：POST

请求参数：

```
user_id // 用户id
```
响应数据：
```
{
    "code": 200,
    "msg": "success"
}
```
## 重启使用
接口地址：bus/user/restart

请求方式：POST

请求参数：

```
user_id // 用户id
```
响应数据：
```
{
    "code": 200,
    "msg": "success"
}
```
## 修改所属学校
接口地址：bus/user/modifyschool

请求方式：POST

请求参数：

```
id // 用户id
school_id // 学校id
```
响应数据：
```
{
    "code": 200,
    "msg": "success"
}
```
## ## 创建反馈记录
接口地址：bus/ticket/feedback

请求方式：POST

请求参数：

```
user_id // 用户id
time // 故障时间，格式yyyy-mm-dd H:i:s
content // 问题和意见
attach // 图片地址，多个地址用英文逗号“,”隔开
```
响应数据：
```
{
    "code": 200,
    "msg": "create success"
}
```
## 反馈记录列表
接口地址：bus/ticket/feedbacklist

请求方式：POST

请求参数：

```
user_id // 用户id
page // 当前页数
size // 每页查询条数
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "id": "5968",// id
            "create_time": "2019-08-07 11:46:09",// 提交时间
            "content": "测试数据",// 反馈内容
            "closed": "0"// 回复标识：0=未回复，1=已回复
        }
    ]
```
## }

反馈记录详情
接口地址：bus/ticket/feedbackinfo

请求方式：POST

请求参数：

```
id // 意见反馈id
user_id // 用户id
```
响应数据：
```
{
    "code": 200,
    "msg": "success",
    "data": [
        {
            "create_time": "2019-08-07 11:46:09",// 提交时间
            "time": "2019-08-07 20:45:48",// 故障时间
            "req_content": "测试数据",// 反馈内容
            "attach": "http:\/\/test1,http:\/\/test2",// 反馈图片，多张图片使用英文逗号“,”隔开
            "closed": "0",// 回复标识：0=未回复，1=已回复
            "res_content": null, // 回复内容
            "res_time": null// 回复时间
        }
    ]
```
}


